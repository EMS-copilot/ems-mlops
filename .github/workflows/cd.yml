name: CD Pipeline

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

env:
  # project meta
  PROJECT_ID: ${{ secrets.GCS_PROJECT_ID }}
  REGION: ${{ secrets.GCS_REGION }}
  ENDPOINT_ID: ${{ secrets.VERTEX_ENDPOINT_ID }}
  SERVICE_ACCOUNT: ${{ secrets.VERTEX_SERVICE_ACCOUNT }}
  # model config
  IMAGE_URI: ${{ secrets.GCS_IMAGE_URI }}
  IMAGE_NAME: ${{ secrets.GCS_IMAGE_NAME}}
  AIP_MODEL_DIR: ${{ secrets.AIP_MODEL_DIR }}

jobs:
  deploy-to-vertex:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          service_account_key: ${{ secrets.GCS_SA_KEY }}
          export_default_credentials: true

      - name: Push Docker image to Artifact Registry
        run: |
          echo "Build: $IMAGE_URI"
          docker build -t $IMAGE_URI .
          docker push $IMAGE_URI

      - name: Upload model to Vertex AI
        run: |
          gcloud ai models upload \
            --project=${PROJECT_ID} \
            --region=${REGION} \
            --display-name=${IMAGE_NAME} \
            --container-health-route="/health" \
            --container-predict-route="/predict" \
            --container-image-uri=$IMAGE_URI \
            --artifact-uri=${AIP_MODEL_DIR}

      - name: Get latest model ID
        run: |
          MODEL_ID=$(gcloud ai models list \
            --project=$PROJECT_ID \
            --region=$REGION \
            --filter="displayName=${IMAGE_NAME}" \
            --sort-by=~createTime \
            --format="value(name)" | head -n 1)
          echo "MODEL_ID=$MODEL_ID" >> $GITHUB_ENV
          echo "MODEL_ID: ${MODEL_ID}"

      - name: Deploy model to Vertex endpoint (0% traffic)
        run: |
          source $GITHUB_ENV
          echo "Deploying model $MODEL_ID to endpoint $ENDPOINT_ID with 0% traffic..."
          gcloud ai endpoints deploy-model \
            $ENDPOINT_ID \
            --project=$PROJECT_ID \
            --region=$REGION \
            --model=$MODEL_ID \
            --display-name=${IMAGE_NAME}-deployed \
            --machine-type=n1-standard-2 \
            --min-replica-count=1 \
            --max-replica-count=1 \
            --service-account=$SERVICE_ACCOUNT

      - name: Get Deployed Model ID
        run: |
          source $GITHUB_ENV
          DEPLOYED_MODEL_ID=$(gcloud ai endpoints describe $ENDPOINT_ID \
            --project=$PROJECT_ID \
            --region=$REGION \
            --format="value(deployedModels[-1].id)")
          echo "DEPLOYED_MODEL_ID=$DEPLOYED_MODEL_ID" >> $GITHUB_ENV
          echo "Deployed Model ID: $DEPLOYED_MODEL_ID"

      - name: Wait for model readiness
        run: |
          echo "Waiting 15s for model to initialize..."
          sleep 15

      - name: Test Model API
        run: |
          source $GITHUB_ENV
          echo "Promoting model $DEPLOYED_MODEL_ID to 100% traffic..."
          
          gcloud ai endpoints update $ENDPOINT_ID \
            --project=$PROJECT_ID \
            --region=$REGION \
            --traffic-split=$DEPLOYED_MODEL_ID=100

          gcloud ai endpoints predict $ENDPOINT_ID\
            --project=$PROJECT_ID \
            --region=$REGION \
            --deployed-model-id=$DEPLOYED_MODEL_ID \
            --json-request=data/input_api_schema.json


      - name: Rollback traffic and clean up on failure
        if: failure()
        run: |
          source $GITHUB_ENV
          echo "Model test failed. Rolling back..."

          PREV_ID=$(gcloud ai endpoints describe $ENDPOINT_ID \
            --project=$PROJECT_ID \
            --region=$REGION \
            --format="value(deployedModels[0].id)")
          if [ -n "$PREV_ID" ]; then
            echo "Rolling back traffic to previous model: $PREV_ID"
          
          gcloud ai endpoints update $ENDPOINT_ID \
            --project=$PROJECT_ID \
            --region=$REGION \
            --traffic-split=$DEPLOYED_MODEL_ID=0
          else
            echo "No previous model found â€” rollback skipped."
          fi

          if [ -n "$DEPLOYED_MODEL_ID" ]; then
            echo "Undeploying failed model: $DEPLOYED_MODEL_ID"
            gcloud ai endpoints undeploy-model $ENDPOINT_ID \
              --project=$PROJECT_ID \
              --region=$REGION \
              --deployed-model-id=$DEPLOYED_MODEL_ID \
              --quiet || true
          fi

          if [ -n "$MODEL_ID" ]; then
            echo "Deleting failed model resource: $MODEL_ID"
            gcloud ai models delete $MODEL_ID \
              --project=$PROJECT_ID \
              --region=$REGION \
              --quiet || true
          fi

      - name: Clean up credentials
        if: always()
        run: rm -f $LOCAL_KEY_FILE